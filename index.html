  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Cheroda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
      body { font-family: Arial, sans-serif; background: linear-gradient(180deg,#001f3f,#003366); color:#e0f7ff; margin:0; padding:0; }
      header { text-align:center; padding:0.5rem; background:rgba(0,0,50,0.6); }
      .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1rem; padding:1rem; }
      .card { background:rgba(255,255,255,0.1); padding:0.2rem; border-radius:1rem; text-align:center; cursor:pointer; }
      .card h2 { margin:0.5rem; font-size:1.2rem; }
      .card p { margin:0.5rem 0 0; font-size:0.9rem; }
      #map { height:400px; margin:1rem; border-radius:1rem; z-index:1; }
      .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.8); align-items:center; justify-content:center; }
      .modal-content { background:#002244; padding:1rem; border-radius:1rem; width:90%; max-width:800px; height:80%; }
      .modal canvas { width:100% !important; height:100% !important; }
      .close { float:right; cursor:pointer; color:white; }
      footer { text-align:center; padding:10px; font-size:0.9rem; color:#a0cbe3; }
      .leaflet-bottom.leaflet-left .legend { background: rgba(10,40,70,0.8); padding:6px 10px; border-radius:8px; color:#e0f7ff; font-size:12px; line-height:1.4; }
      .legend .color-box { display:inline-block; width:20px; height:10px; margin-right:4px; }
      .nautical-control { background: rgba(0,40,80,0.9); padding:6px 8px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.5); color:#e0f7ff; font-size:0.9rem; }
      .nautical-control label { margin-right:0.3rem; font-weight:bold; }
      .nautical-control select, .nautical-control button { background:#004080; color:#e0f7ff; border:1px solid #1ecbe1; border-radius:6px; padding:0.2rem 0.5rem; margin:0.2rem 0; cursor:pointer; font-size:0.85rem; transition: background 0.3s; }
      .nautical-control select:hover, .nautical-control button:hover { background:#0066cc; }
    </style>
  </head>
  <body>
    <header>
      <h1>â›µ Cheroda</h1>
    </header>
    <div class="grid">
      <div class="card" onclick="showChart('speed')">
        <h2 id="speed">--</h2><p>Speed (km/h)</p>
      </div>
      <div class="card" onclick="showChart('voltage')">
        <h2 id="voltage">--</h2><p>Voltage (V)</p>
      </div>
      <div class="card" onclick="showChart('temperature')">
        <h2 id="temperature">--</h2><p>Temperature (Â°C)</p>
      </div>
      <div class="card" onclick="showChart('float')">
        <h2 id="float">--</h2><p>Float</p>
      </div>
      <div class="card" onclick="showChart('distance')">
        <h2 id="distance">--</h2><p>Distance (km)</p>
      </div>
    </div>
    <div id="map"></div>

    <div class="modal" id="chartModal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <canvas id="chartCanvas"></canvas>
      </div>
    </div>

    <footer>
      Last update: <span id="lastUpdate">loadingâ€¦</span>
    </footer>

  <script>
  const REFRESH_MS = 60000;
  const TOP_SPEED = 12;
  let map, chart, marker, startMarker, endMarker;
  let followLatest = true;
  let days = 1;

  function getApiUrl() {
    return `https://api.thingspeak.com/channels/2831954/feeds.json?api_key=W5FGDFBD5PK7GY2T&location=true&results=8000`;
  }

  function toDutchNumber(val) { return (val!==null && !isNaN(val))?val.toFixed(1).replace('.',','):"--"; }
  function toAmsterdamTime(utcString) { return new Date(utcString).toLocaleString("nl-NL",{timeZone:"Europe/Amsterdam"}); }

  function speedColor(speed){
    const ratio=Math.min(speed/TOP_SPEED,1);
    if(ratio<0.33) return `rgb(0,${Math.floor(255*ratio*3)},255)`;
    if(ratio<0.66) return `rgb(${Math.floor(255*(ratio-0.33)*3)},255,255)`;
    return `rgb(255,${Math.floor(255*(1-(ratio-0.66)*3))},0)`;
  }

  function initMap() {
    map = L.map('map').setView([52,5],7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
    addSpeedLegend();
    addControls();
    marker=L.marker([52,5]).addTo(map);
  }

  function addSpeedLegend() {
    const legend=L.control({position:'bottomleft'});
    legend.onAdd=function(){
      const div=L.DomUtil.create('div','legend');
      [0,4,8,12].forEach(s=>{ div.innerHTML+=`<div><span class="color-box" style="background:${speedColor(s)}"></span>${s} km/h</div>`; });
      return div;
    };
    legend.addTo(map);
  }

  function addControls() {
    const ctrl=L.control({position:'topright'});
    ctrl.onAdd=function(){
      const div=L.DomUtil.create('div','nautical-control');
      div.innerHTML=`
        <div>
          <label for="daysSelect">ðŸ“… Days:</label>
          <select id="daysSelect">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="7">7</option>
            <option value="14">14</option>
            <option value="30">30</option>
            <option value="90">90</option>
            <option value="190">180</option>
            <option value="365">365</option>
          </select>
        </div>
        <div>
          <button id="toggleViewBtn">âš“ Show Full Track</button>
        </div>
      `;
      return div;
    };
    ctrl.addTo(map);

    setTimeout(()=>{
      document.getElementById("toggleViewBtn").onclick=function(){
        followLatest=!followLatest;
        this.textContent=followLatest?"âš“ Show Full Track":"âš“ Follow Latest";
        fetchData();
      };
      document.getElementById("daysSelect").onchange=function(){
        days=this.value;
        fetchData();
      };
    },100);
  }

  function haversineDistance(lat1,lon1,lat2,lon2){
    const R=6371;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
  }

  async function fetchData() {
    const res = await fetch(getApiUrl());
    const data = await res.json();

    // Filter feeds with valid lat/lon and 0.0 excluded
    let feeds = data.feeds.filter(f =>
      f.latitude && f.longitude &&
      parseFloat(f.latitude)!==0.0 && parseFloat(f.longitude)!==0.0
    );
    if(!feeds.length) return;

    // Filter by selected day(s)
    const now=new Date();
    const amsterdamOffset=2*60;
    const localNow=new Date(now.getTime() + (now.getTimezoneOffset() + amsterdamOffset)*60000);
    const startDay=new Date(localNow.getFullYear(), localNow.getMonth(), localNow.getDate()-(days-1));

    feeds = feeds.filter(f=>{
      const feedDate=new Date(f.created_at);
      const feedLocal=new Date(feedDate.getTime() + (feedDate.getTimezoneOffset()+amsterdamOffset)*60000);
      return feedLocal >= startDay;
    });

    if(!feeds.length) return;

    const latest = feeds[feeds.length-1];

    document.getElementById("speed").textContent = toDutchNumber(parseFloat(latest.field4));
    document.getElementById("voltage").textContent = toDutchNumber(parseFloat(latest.field1));
    document.getElementById("temperature").textContent = toDutchNumber(parseFloat(latest.field2));
    document.getElementById("float").textContent = latest.field3=="1"?"ON":"OFF";
    document.getElementById("lastUpdate").textContent = toAmsterdamTime(latest.created_at);

    map.eachLayer(l=>{ if(l instanceof L.Polyline || l instanceof L.CircleMarker) map.removeLayer(l); });
    if(startMarker) map.removeLayer(startMarker);
    if(endMarker) map.removeLayer(endMarker);

    const latlngs = feeds.map(f=>[parseFloat(f.latitude),parseFloat(f.longitude),parseFloat(f.field4)||0]);

    // Draw track
    for(let i=0;i<latlngs.length-1;i++){
      L.polyline([latlngs[i],latlngs[i+1]],{color:speedColor(latlngs[i][2]),weight:4}).addTo(map);
    }

    // Start marker
    if(latlngs.length>0){
      startMarker=L.marker(latlngs[0],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/190/190411.png',iconSize:[25,41],iconAnchor:[12,41]})}).addTo(map).bindPopup("Start");
    }

    // Waypoints every 10 points
    for(let i=0;i<latlngs.length;i+=10){
      const f=feeds[i];
      const popupContent=`
        <b>${toAmsterdamTime(f.created_at)}</b><br>
        ðŸš¤ Speed: ${toDutchNumber(parseFloat(f.field4))} km/h<br>
        ðŸ”‹ Voltage: ${toDutchNumber(parseFloat(f.field1))} V<br>
        ðŸŒ¡ Temp: ${toDutchNumber(parseFloat(f.field2))} Â°C<br>
        ðŸ’§ Float: ${f.field3=="1"?"ON":"OFF"}
      `;
      L.circleMarker([f.latitude,f.longitude],{radius:4,color:'blue',fillOpacity:0.7}).addTo(map).bindPopup(popupContent);
    }

    marker.setLatLng([latest.latitude,latest.longitude]).bindPopup(`
      <b>Latest</b><br>
      ðŸš¤ Speed: ${toDutchNumber(parseFloat(latest.field4))} km/h<br>
      ðŸ”‹ Voltage: ${toDutchNumber(parseFloat(latest.field1))} V<br>
      ðŸŒ¡ Temp: ${toDutchNumber(parseFloat(latest.field2))} Â°C<br>
      ðŸ’§ Float: ${latest.field3=="1"?"ON":"OFF"}
    `);

    if(followLatest){
      map.setView([latest.latitude,latest.longitude],14);
    } else {
      map.fitBounds(latlngs,{padding:[30,30]});
    }

    // Calculate total distance
    let totalDistance=0;
    for(let i=0;i<latlngs.length-1;i++){
      totalDistance+=haversineDistance(latlngs[i][0],latlngs[i][1],latlngs[i+1][0],latlngs[i+1][1]);
    }
    document.getElementById("distance").textContent=totalDistance.toFixed(2).replace('.',',');
  }

  function showChart(type){
  document.getElementById("chartModal").style.display="flex";
  if(chart) chart.destroy();

  fetch(getApiUrl()).then(res=>res.json()).then(data=>{
    let feeds = data.feeds.filter(f =>
      f.latitude && f.longitude &&
      parseFloat(f.latitude)!==0.0 && parseFloat(f.longitude)!==0.0
    );

    // Filter by selected days
    const now = new Date();
    const amsterdamOffset = 2*60;
    const localNow = new Date(now.getTime() + (now.getTimezoneOffset() + amsterdamOffset)*60000);
    const startDay = new Date(localNow.getFullYear(), localNow.getMonth(), localNow.getDate()-(days-1));

    feeds = feeds.filter(f=>{
      const feedDate = new Date(f.created_at);
      const feedLocal = new Date(feedDate.getTime() + (feedDate.getTimezoneOffset()+amsterdamOffset)*60000);
      return feedLocal >= startDay;
    });

    let labels = [];
    let values = [];
    let title = "";
    let unit = "";

    if(type==="speed"){ 
      title="Speed"; unit="km/h"; 
      feeds.forEach(f=>{
        const val = parseFloat(f.field4);
        if(val!=null) { labels.push(toAmsterdamTime(f.created_at)); values.push(val); }
      });
    }
    if(type==="voltage"){ 
      title="Voltage"; unit="V"; 
      feeds.forEach(f=>{
        const val = parseFloat(f.field1);
        if(val!=null) { labels.push(toAmsterdamTime(f.created_at)); values.push(val); }
      });
    }
    if(type==="temperature"){ 
      title="Temperature"; unit="Â°C"; 
      feeds.forEach(f=>{
        const val = parseFloat(f.field2);
        if(val!=null) { labels.push(toAmsterdamTime(f.created_at)); values.push(val); }
      });
    }
    if(type==="float"){ 
      title="Float"; unit=""; 
      feeds.forEach(f=>{
        const val = parseInt(f.field3);
        if(val===0 || val===1){ labels.push(toAmsterdamTime(f.created_at)); values.push(val); }
      });
    }
    if(type==="distance"){
      title = "Distance per Day"; unit = "km";
      const dailyDistances = {};
      feeds.forEach((f,i)=>{
        if(i===0) return;
        const prev = feeds[i-1];

        const currDate = new Date(f.created_at);
        const prevDate = new Date(prev.created_at);
        if(currDate < startDay || prevDate < startDay) return;

        if(parseFloat(prev.latitude)===0.0 || parseFloat(prev.longitude)===0.0 ||
           parseFloat(f.latitude)===0.0 || parseFloat(f.longitude)===0.0) return;

        // Assign distance to the day of the current point in Amsterdam time
        const day = new Date(currDate.getTime() + (currDate.getTimezoneOffset()+amsterdamOffset)*60000)
                    .toISOString().split('T')[0];
        const dist = haversineDistance(
          parseFloat(prev.latitude), parseFloat(prev.longitude),
          parseFloat(f.latitude), parseFloat(f.longitude)
        );
        if(dailyDistances[day]) dailyDistances[day] += dist;
        else dailyDistances[day] = dist;
      });

      labels = Object.keys(dailyDistances).sort();
      values = labels.map(day => parseFloat(dailyDistances[day].toFixed(2)));
    }

    // Create Chart
    chart = new Chart(document.getElementById("chartCanvas"), {
      type: type==="distance"? 'bar':'line',
      data: {
        labels,
        datasets: [{
          label: title,
          data: values,
          borderColor:'#1ecbe1',
          backgroundColor:'rgba(30,203,225,0.2)',
          tension: type==="float"?0:0.2,
          stepped: type==="float"?true:false,
          pointRadius:2
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{display:false} },
        scales:{
          y: type==="float"?{
            min:-0.1, max:1.1,
            ticks:{ callback: v => v==1?"ON":"OFF" }
          }:undefined
        }
      }
    });
  });
}

  function closeModal(){ document.getElementById("chartModal").style.display="none"; }
  window.onclick=function(event){ if(event.target==document.getElementById("chartModal")) closeModal(); }

  initMap();
  fetchData();
  setInterval(fetchData, REFRESH_MS);
  </script>
  </body>
  </html>

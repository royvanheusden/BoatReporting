<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boat Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom, #001f3f, #003f5c);
      color: #e0f7ff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 1rem;
      text-align: center;
      background: #002f47;
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 2px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .card:hover { transform: scale(1.05); }
    .label { font-size: 1rem; margin-bottom: 0.5rem; }
    .value { font-size: 2rem; font-weight: bold; }
    #map {
      flex: 1;
      margin: 1rem;
      border-radius: 1rem;
      overflow: hidden;
    }
    footer {
      text-align:center;
      padding:10px;
      font-size:0.9rem;
      color:#a0cbe3;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
    }
    .modal-content {
      background: #003f5c;
      margin: 5% auto;
      padding: 1rem;
      border-radius: 1rem;
      width: 90%;
      max-width: 800px;
      height: 500px;
      display: flex;
      flex-direction: column;
    }
    #chartCanvas { flex: 1; }
    .close {
      color: #fff;
      float: right;
      font-size: 1.5rem;
      cursor: pointer;
    }
    /* Legend */
    .legend {
      background: rgba(10,40,70,0.8);
      padding: 6px 10px;
      border-radius: 8px;
      color: #e0f7ff;
      font-size: 12px;
      line-height: 1.4;
    }
    .legend .color-box {
      display: inline-block;
      width: 20px;
      height: 10px;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <header>⛵ Boat Live Dashboard</header>

  <div class="dashboard">
    <div class="card" onclick="showChart('Speed','km/h')">
      <div class="label">Speed</div>
      <div id="speed" class="value">--</div>
    </div>
    <div class="card" onclick="showChart('Voltage','V')">
      <div class="label">Voltage</div>
      <div id="voltage" class="value">--</div>
    </div>
    <div class="card" onclick="showChart('Temperature','°C')">
      <div class="label">Temperature</div>
      <div id="temperature" class="value">--</div>
    </div>
    <div class="card">
      <div class="label">Float Sensor</div>
      <div id="float" class="value">--</div>
    </div>
  </div>

  <div id="map"></div>

  <footer>
    Last update: <span id="lastUpdate">loading…</span>
  </footer>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <canvas id="chartCanvas"></canvas>
    </div>
  </div>

  <script>
    const CHANNEL_ID = "2831954";
    const API_KEY = "W5FGDFBD5PK7GY2T";
    const REFRESH_MS = 60000; // 60s

    let map, chart;

    function speedColor(speed) {
      if (speed <= 4) return "#2ecc71"; // green
      if (speed <= 8) return "#f1c40f"; // yellow
      return "#e74c3c"; // red
    }

    function initMap() {
      map = L.map("map").setView([52, 5], 7);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap"
      }).addTo(map);
    }

    function addSpeedLegend() {
      const legend = L.control({position: 'bottomleft'});
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        const speeds = [0, 4, 8, 12];
        speeds.forEach(s => {
          const color = speedColor(s);
          div.innerHTML += `<div><span class="color-box" style="background:${color}"></span>${s} km/h</div>`;
        });
        return div;
      };
      legend.addTo(map);
    }

    function toDutchNumber(num) {
      return num.toFixed(1).replace(".", ",");
    }

    function toAmsterdamTime(utcString) {
      const date = new Date(utcString);
      return date.toLocaleString("nl-NL", { timeZone: "Europe/Amsterdam" });
    }

    async function fetchData() {
      const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${API_KEY}&days=1&location=true`;
      const res = await fetch(url);
      const data = await res.json();
      const feeds = data.feeds;

      if (feeds.length === 0) return;

      const last = feeds[feeds.length-1];
      document.getElementById("speed").textContent = toDutchNumber(parseFloat(last.field4));
      document.getElementById("voltage").textContent = toDutchNumber(parseFloat(last.field1));
      document.getElementById("temperature").textContent = toDutchNumber(parseFloat(last.field2));
      document.getElementById("float").textContent = last.field3 == "1" ? "ON" : "OFF";

      // Last update footer (convert UTC to Amsterdam)
      document.getElementById("lastUpdate").textContent = toAmsterdamTime(last.created_at);

      // Map with colored segments
      const latlngs = [];
      for (let i = 1; i < feeds.length; i++) {
        const prev = feeds[i-1];
        const curr = feeds[i];
        if (prev.latitude && prev.longitude && curr.latitude && curr.longitude) {
          const latlng1 = [parseFloat(prev.latitude), parseFloat(prev.longitude)];
          const latlng2 = [parseFloat(curr.latitude), parseFloat(curr.longitude)];
          const spd = parseFloat(curr.field4) || 0;
          L.polyline([latlng1, latlng2], { color: speedColor(spd), weight: 3 }).addTo(map);
          latlngs.push(latlng1, latlng2);
        }
      }
      if (latlngs.length>0) {
        map.fitBounds(latlngs, {padding:[30,30]});
        L.marker(latlngs[0], {title:"Start", icon: L.divIcon({className:"", html:"<span style='color:lime'>⬤ Start</span>"})}).addTo(map);
        L.marker(latlngs[latlngs.length-1], {title:"End", icon: L.divIcon({className:"", html:"<span style='color:red'>⬤ End</span>"})}).addTo(map);
      }
    }

    function showChart(type, unit) {
      document.getElementById("modal").style.display = "block";
      if (chart) chart.destroy();

      fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${API_KEY}&results=200`)
        .then(res=>res.json())
        .then(data=>{
          const feeds = data.feeds;
          const labels = feeds.map(f=> toAmsterdamTime(f.created_at));
          let values;
          if (type==="Speed") values = feeds.map(f=> parseFloat(f.field4));
          if (type==="Voltage") values = feeds.map(f=> parseFloat(f.field1));
          if (type==="Temperature") values = feeds.map(f=> parseFloat(f.field2));

          chart = new Chart(document.getElementById("chartCanvas"), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: type,
                data: values,
                borderColor: '#1ecbe1',
                backgroundColor: 'rgba(30,203,225,0.2)',
                tension: 0.2,
                pointRadius: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: { y: { title: { display: true, text: unit } } }
            }
          });
        });
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    initMap();
    addSpeedLegend();
    fetchData();
    setInterval(fetchData, REFRESH_MS);
  </script>
</body>
</html>

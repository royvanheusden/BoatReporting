<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Boat Live Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { margin:0; font-family:Arial,sans-serif; background: linear-gradient(to bottom, #0a2540, #093a59, #02111d); color:#e0f7ff; }
    header { display:flex; justify-content:space-between; align-items:center; padding:1rem; background:rgba(10,40,70,0.8);}
    header h1 { margin:0; font-size:1.4rem; }
    button { background:#136f9c; border:none; padding:0.5rem 1rem; border-radius:8px; color:white; cursor:pointer;}
    main { display:grid; grid-template-columns:1fr 1fr; gap:1rem; padding:1rem;}
    .card { background: rgba(15,50,80,0.7); border-radius:16px; padding:1rem; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); cursor:pointer; transition: transform 0.2s; }
    .card:hover { transform: scale(1.03);}
    .card h2 { margin:0.3rem 0; font-size:1.1rem;}
    .value { font-size:2rem; font-weight:bold; margin-top:0.3rem;} /* compact live values */
    #map { grid-column: span 2; height:450px; border-radius:16px; overflow:hidden;}
    footer { text-align:center; font-size:0.8rem; padding:1rem; color:#a0c7e0;}
    /* Modal for charts */
    #modal { position:fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:1000;}
    #modal-content { background:#0a2540; padding:1rem; border-radius:12px; max-width:95%; max-height:95%; color:white;}
    #modal canvas { width:100%; height:500px;} /* large chart */
    #closeBtn { background:#136f9c; border:none; color:white; padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer; margin-bottom:0.5rem;}
    /* Legend */
    .leaflet-bottom.leaflet-left .legend {
      background: rgba(10,40,70,0.8);
      padding: 6px 10px;
      border-radius: 8px;
      color: #e0f7ff;
      font-size: 12px;
      line-height: 1.4;
    }
    .legend .color-box {
      display: inline-block;
      width: 20px;
      height: 10px;
      margin-right: 4px;
    }
  </style>
</head>
<body>

  <header>
    <h1>⚓ Boat Live Dashboard</h1>
    <button onclick="fetchData()">Refresh</button>
  </header>

  <main>
    <div class="card" onclick="showChart('field4','Speed (km/h)','km/h')">
      <h2>Speed</h2>
      <div id="speed" class="value">--</div>
    </div>
    <div class="card" onclick="showChart('field1','Voltage (V)','V')">
      <h2>Voltage</h2>
      <div id="voltage" class="value">--</div>
    </div>
    <div class="card" onclick="showChart('field2','Temperature (°C)','°C')">
      <h2>Temperature</h2>
      <div id="temperature" class="value">--</div>
    </div>
    <div class="card">
      <h2>Float Sensor</h2>
      <div id="float" class="value">--</div>
    </div>
    <div id="map"></div>
  </main>

  <footer>
    Data from ThingSpeak • Auto-refresh every 15s
  </footer>

  <!-- Modal -->
  <div id="modal">
    <div id="modal-content">
      <button id="closeBtn" onclick="closeModal()">Close</button>
      <h3 id="chartTitle"></h3>
      <canvas id="chartCanvas"></canvas>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const API_LATEST = "https://api.thingspeak.com/channels/2831954/feeds.json?api_key=W5FGDFBD5PK7GY2T&results=1&location=true&days=1";
    const API_HISTORY = "https://api.thingspeak.com/channels/2831954/feeds.json?api_key=W5FGDFBD5PK7GY2T&results=200&location=true&days=1";
    const API_FULL_DAY = "https://api.thingspeak.com/channels/2831954/feeds.json?api_key=W5FGDFBD5PK7GY2T&results=8000&location=true&days=1";
    const REFRESH_MS = 15000;
    const TOP_SPEED = 12;

    let map, marker, chart, polyline, startMarker, endMarker;

    function initMap(lat=52,lng=5){
      map = L.map("map").setView([lat,lng],12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution:"&copy; OpenStreetMap contributors"}).addTo(map);
      marker=L.marker([lat,lng]).addTo(map);
    }

    function addSpeedLegend() {
      const legend = L.control({position: 'bottomleft'});
      legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        const speeds = [0, 4, 8, 12];
        speeds.forEach(s => {
          const color = speedColor(s);
          div.innerHTML += `<div><span class="color-box" style="background:${color}"></span>${s} km/h</div>`;
        });
        return div;
      };
      legend.addTo(map);
    }

    function speedColor(speed){
      const ratio=Math.min(speed/TOP_SPEED,1);
      if(ratio<0.33) return `rgb(0,${Math.floor(255*ratio*3)},255)`;
      if(ratio<0.66) return `rgb(${Math.floor(255*(ratio-0.33)*3)},255,255)`;
      return `rgb(255,${Math.floor(255*(1-(ratio-0.66)*3))},0)`;
    }

    async function fetchData(){
      try {
        const res=await fetch(API_LATEST);
        const json=await res.json();
        const latest=json.feeds[json.feeds.length-1];

        document.getElementById("speed").textContent = latest.field4 ? parseFloat(latest.field4).toFixed(1)+" km/h":"--";
        document.getElementById("voltage").textContent = latest.field1 ? parseFloat(latest.field1).toFixed(1)+" V":"--";
        document.getElementById("temperature").textContent = latest.field2 ? parseFloat(latest.field2).toFixed(1)+" °C":"--";
        document.getElementById("float").textContent = latest.field3==="1"?"Active":"Inactive";

        if(latest.latitude && latest.longitude){
          const lat=parseFloat(latest.latitude);
          const lng=parseFloat(latest.longitude);
          map.setView([lat,lng],13);
          marker.setLatLng([lat,lng]).bindPopup(
            `Speed: ${latest.field4?parseFloat(latest.field4).toFixed(1):"--"} km/h<br>`+
            `Voltage: ${latest.field1?parseFloat(latest.field1).toFixed(1):"--"} V<br>`+
            `Temp: ${latest.field2?parseFloat(latest.field2).toFixed(1):"--"} °C<br>`+
            `Float: ${latest.field3==="1"?"Active":"Inactive"}`
          );
        }

        await plotFullTrip();
      } catch(e){console.error("Fetch error:",e);}
    }

    async function plotFullTrip(){
      try {
        const res=await fetch(API_FULL_DAY);
        const json=await res.json();
        const feeds=json.feeds.filter(f=>f.latitude && f.longitude);
        const latlngs=feeds.map(f=>[parseFloat(f.latitude),parseFloat(f.longitude),parseFloat(f.field4)||0]);

        // Remove old layers
        if(polyline) map.removeLayer(polyline);
        if(startMarker) map.removeLayer(startMarker);
        if(endMarker) map.removeLayer(endMarker);

        // Draw colored segments for speed
        for(let i=0;i<latlngs.length-1;i++){
          L.polyline([latlngs[i],latlngs[i+1]],{color:speedColor(latlngs[i][2]),weight:4}).addTo(map);
        }

        // Start & End markers
        if(latlngs.length>0){
          startMarker=L.marker(latlngs[0],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/190/190411.png',iconSize:[25,41],iconAnchor:[12,41]})}).addTo(map).bindPopup("Start");
          endMarker=L.marker(latlngs[latlngs.length-1],{icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/190/190423.png',iconSize:[25,41],iconAnchor:[12,41]})}).addTo(map).bindPopup("End");
        }

        // Waypoints every 10 points
        for(let i=0;i<latlngs.length;i+=10){
          L.circleMarker(latlngs[i],{radius:4,color:'blue',fillOpacity:0.7}).addTo(map);
        }

      } catch(e){console.error("Trip plot error:",e);}
    }

    async function showChart(field,title,unit){
      try {
        const res=await fetch(API_HISTORY);
        const json=await res.json();
        const feeds=json.feeds;

        const labels=feeds.map(f=>new Date(f.created_at).toLocaleTimeString());
        const values=fee
